---
title: "classifier"
author: "jason grahn"
date: "5/25/2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)
library(psych)
library(magrittr)
library(cluster)
library(cluster.datasets)
library(cowplot)
library(NbClust)
library(clValid)
library(ggfortify)
library(clustree)
library(dendextend)
library(factoextra)
library(FactoMineR)
library(corrplot)
library(GGally)
#library(ggiraphExtra)
library(knitr)
library(kableExtra)

set.seed(310)
```

```{r import data}
#load training
dir <- "data"
train_doc <- "train_data.csv"

training <- read_csv(here::here(dir,train_doc)) %>% 
  dplyr::select(-contains("X"), -id)

#load testing
test_doc <- "train_data.csv"

testing <- read_csv(here::here(dir,test_doc)) %>% 
  dplyr::select(-contains("X"), -id)
```

```{r build and use model 1}
model.1 <- lm(grad_rate ~ student_count +spending_per_award +full_time_pct
             +full_time_count +med_sat_value +aid_value
             +endow_value +grad_on_time_pct +pell_value +fresh_retain_value
             + full_time_fac_pct,
             data = training)

#remove outliers using model 1
training_without_outliers <- add_residuals(data = training,
                                           model = model.1,
                                           var = "resid") %>% 
  mutate(sdev = sd(resid),
                std.norm = resid / sdev,
                abs.std = abs(std.norm)) %>% #note: 407 rows at this point
   #dplyr::arrange(desc(abs.std)) %>% 
  filter(abs.std < 2)
```


```{r rebuild model 10 from the LM}
model.10 <- lm(grad_rate ~ spending_per_award 
               + full_time_count
               + med_sat_value
               + endow_value
               + grad_on_time_pct
               + pell_value
               + fresh_retain_value
             + endow_value*spending_per_award     #EndowXSpend
             + pell_value*med_sat_value           #PellXSat
             + fresh_retain_value*med_sat_value   #RetainXSat
             ,data = training_without_outliers)
```

```{r add predictions back to training set}
training_with_predictions <- add_predictions(training_without_outliers, model.10, var = "pred_grad_rate") %>% 
  #and we dont need these other variables either
  dplyr::select(-resid, -sdev, -std.norm, -abs.std) %>% 
  mutate(scaled = scale(pred_grad_rate))

#and a quick visual of known graduation to predicuted graduation
training_with_predictions %>% 
  ggplot(aes(x = grad_rate, y = pred_grad_rate)) +
  geom_point() + 
  geom_rug() +
  theme_light()

#histogram of scaled predictions
training_with_predictions %>% 
  ggplot() +
  geom_histogram(aes(x = scaled), bins = 25)
```


